<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIë³„ í”„ë¡¬í”„íŠ¸ í†µí•© ê´€ë¦¬ - EORA AI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .nav-menu {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 15px 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .nav-menu a {
            text-decoration: none;
            color: #333;
            padding: 8px 15px;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-weight: 500;
            margin: 2px;
        }

        .nav-menu a:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .nav-menu a.active {
            background: #667eea;
            color: white;
        }

        .page-header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .page-title {
            font-size: 2.5em;
            color: #333;
            margin-bottom: 10px;
        }

        .page-subtitle {
            color: #666;
            font-size: 1.1em;
        }

        /* AI ì„ íƒ íƒ­ */
        .ai-tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .ai-tab {
            flex: 1;
            min-width: 120px;
            padding: 12px 20px;
            text-align: center;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            white-space: nowrap;
        }

        .ai-tab.active {
            background: #667eea;
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .ai-tab:hover:not(.active) {
            background: rgba(102, 126, 234, 0.1);
        }

        /* ì¹´í…Œê³ ë¦¬ í¸ì§‘ ì„¹ì…˜ */
        .category-editor {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .category-title {
            font-size: 1.5em;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
        }

        .category-icon {
            margin-right: 10px;
            font-size: 1.2em;
        }

        .category-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        /* í”„ë¡¬í”„íŠ¸ í•­ëª© */
        .prompt-item {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .prompt-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .prompt-item.editing {
            border-color: #28a745;
            background: #f8fff9;
        }

        .prompt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .prompt-index {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .prompt-actions {
            display: flex;
            gap: 8px;
        }

        .prompt-content {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            min-height: 100px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .prompt-content:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        /* ìƒˆ í”„ë¡¬í”„íŠ¸ ì¶”ê°€ */
        .add-prompt-section {
            background: #e8f5e8;
            border: 2px dashed #28a745;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-top: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-prompt-section:hover {
            background: #d4edda;
            border-color: #218838;
        }

        .add-prompt-icon {
            font-size: 2em;
            color: #28a745;
            margin-bottom: 10px;
        }

        /* ì €ì¥ ìƒíƒœ í‘œì‹œ */
        .save-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .save-status.show {
            opacity: 1;
            transform: translateX(0);
        }

        .save-status.success {
            background: #28a745;
        }

        .save-status.error {
            background: #dc3545;
        }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .ai-tabs {
                flex-direction: column;
            }

            .ai-tab {
                min-width: auto;
            }

            .category-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            .category-actions {
                width: 100%;
                justify-content: space-between;
            }
        }

        /* í”„ë¡¬í”„íŠ¸ ì•„ì´í…œ */
        .prompt-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: background 0.2s;
        }

        /* í†µí•© í…ìŠ¤íŠ¸ ì˜ì—­ ìŠ¤íƒ€ì¼ */
        .unified-textarea {
            width: 100%;
            min-height: 400px;
            font-family: 'Courier New', monospace;
            font-size: 1em;
            line-height: 1.6;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            resize: vertical;
            background: #f9f9f9;
            transition: all 0.3s ease;
        }

        .unified-textarea:focus {
            outline: none;
            border-color: #667eea;
            background: #fff;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .category-description {
            margin-top: 10px;
            padding: 10px 15px;
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            border-radius: 4px;
            color: #555;
            font-size: 0.9em;
            font-style: italic;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- ë„¤ë¹„ê²Œì´ì…˜ ë©”ë‰´ -->
        <div class="nav-menu">
            <div>
                <a href="/admin">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</a>
                <a href="/storage-management">ì €ì¥ì†Œ ê´€ë¦¬</a>
                <a href="/prompt-management" class="active">í”„ë¡¬í”„íŠ¸ ê´€ë¦¬</a>
            </div>
            <div>
                <a href="/dashboard">ëŒ€ì‹œë³´ë“œ</a>
                <a href="/chat">ì±„íŒ…</a>
                <a href="/" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</a>
            </div>
        </div>

        <!-- í˜ì´ì§€ í—¤ë” -->
        <div class="page-header">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div>
                    <h1 class="page-title">ğŸ¤– AIë³„ í”„ë¡¬í”„íŠ¸ í†µí•© ê´€ë¦¬</h1>
                    <p class="page-subtitle">ê° AIì˜ ì‹œìŠ¤í…œ, ì—­í• , ê°€ì´ë“œ, í¬ë§·ì„ ì¹´í…Œê³ ë¦¬ë³„ë¡œ í†µí•© ê´€ë¦¬í•©ë‹ˆë‹¤</p>
                </div>
                <a href="/admin" class="btn btn-primary"
                    style="text-decoration: none; color: white; padding: 12px 24px; border-radius: 10px; background: #667eea; transition: all 0.3s ease;">
                    ğŸ”™ ê´€ë¦¬ì í˜ì´ì§€ë¡œ
                </a>
            </div>
        </div>

        <!-- AI ì„ íƒ íƒ­ -->
        <div class="ai-tabs">
            <button class="ai-tab active" data-ai="ai1">AI1 (ì´ì˜¤ë¼)</button>
            <button class="ai-tab" data-ai="ai2">AI2 (API ì„¤ê³„)</button>
            <button class="ai-tab" data-ai="ai3">AI3 (ì½”ë“œ ë¦¬íŒ©í† ë§)</button>
            <button class="ai-tab" data-ai="ai4">AI4 (í…ŒìŠ¤íŠ¸/QA)</button>
            <button class="ai-tab" data-ai="ai5">AI5 (ë³´ì•ˆ ê°ì‚¬)</button>
            <button class="ai-tab" data-ai="ai6">AI6 (ë¬¸ì„œ ìë™í™”)</button>
        </div>

        <!-- ì¹´í…Œê³ ë¦¬ë³„ í¸ì§‘ ì„¹ì…˜ -->
        <div id="category-editors">
            <!-- ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ -->
            <div class="category-editor" id="system-editor">
                <div class="category-header">
                    <h3 class="category-title">
                        <span class="category-icon">âš™ï¸</span>
                        ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
                    </h3>
                    <div class="category-actions">
                        <button class="btn btn-success" onclick="saveCategory('system')">
                            ğŸ’¾ ì €ì¥
                        </button>
                        <button class="btn btn-secondary" onclick="addPromptItem('system')">
                            â• ì¶”ê°€
                        </button>
                    </div>
                </div>
                <div id="system-prompts" class="prompts-container">
                    <!-- í”„ë¡¬í”„íŠ¸ í•­ëª©ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
            </div>

            <!-- ì—­í•  í”„ë¡¬í”„íŠ¸ -->
            <div class="category-editor" id="role-editor">
                <div class="category-header">
                    <h3 class="category-title">
                        <span class="category-icon">ğŸ­</span>
                        ì—­í•  í”„ë¡¬í”„íŠ¸
                    </h3>
                    <div class="category-actions">
                        <button class="btn btn-success" onclick="saveCategory('role')">
                            ğŸ’¾ ì €ì¥
                        </button>
                        <button class="btn btn-secondary" onclick="addPromptItem('role')">
                            â• ì¶”ê°€
                        </button>
                    </div>
                </div>
                <div id="role-prompts" class="prompts-container">
                    <!-- í”„ë¡¬í”„íŠ¸ í•­ëª©ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
            </div>

            <!-- ê°€ì´ë“œ í”„ë¡¬í”„íŠ¸ -->
            <div class="category-editor" id="guide-editor">
                <div class="category-header">
                    <h3 class="category-title">
                        <span class="category-icon">ğŸ“‹</span>
                        ê°€ì´ë“œ í”„ë¡¬í”„íŠ¸
                    </h3>
                    <div class="category-actions">
                        <button class="btn btn-success" onclick="saveCategory('guide')">
                            ğŸ’¾ ì €ì¥
                        </button>
                        <button class="btn btn-secondary" onclick="addPromptItem('guide')">
                            â• ì¶”ê°€
                        </button>
                    </div>
                </div>
                <div id="guide-prompts" class="prompts-container">
                    <!-- í”„ë¡¬í”„íŠ¸ í•­ëª©ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
            </div>

            <!-- í¬ë§· í”„ë¡¬í”„íŠ¸ -->
            <div class="category-editor" id="format-editor">
                <div class="category-header">
                    <h3 class="category-title">
                        <span class="category-icon">ğŸ“</span>
                        í¬ë§· í”„ë¡¬í”„íŠ¸
                    </h3>
                    <div class="category-actions">
                        <button class="btn btn-success" onclick="saveCategory('format')">
                            ğŸ’¾ ì €ì¥
                        </button>
                        <button class="btn btn-secondary" onclick="addPromptItem('format')">
                            â• ì¶”ê°€
                        </button>
                    </div>
                </div>
                <div id="format-prompts" class="prompts-container">
                    <!-- í”„ë¡¬í”„íŠ¸ í•­ëª©ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>
    </div>

    <!-- ì €ì¥ ìƒíƒœ í‘œì‹œ -->
    <div id="save-status" class="save-status"></div>

    <script>
        let currentAI = 'ai1';
        let promptsData = {};
        let originalData = {};

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function () {
            // í”„ë¡¬í”„íŠ¸ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (ì§„ë‹¨ìš© ì½˜ì†” ì¶œë ¥ ì¶”ê°€)
            fetch('/api/prompts')
                .then(res => res.json())
                .then(data => {
                    console.log('[í”„ë¡ íŠ¸] /api/prompts ì‘ë‹µ:', data);
                    loadPrompts();
                    setupEventListeners();
                });
        });

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupEventListeners() {
            // AI íƒ­ í´ë¦­ ì´ë²¤íŠ¸
            document.querySelectorAll('.ai-tab').forEach(tab => {
                tab.addEventListener('click', function () {
                    const ai = this.dataset.ai;
                    switchAI(ai);
                });
            });
        }

        // AI ì „í™˜
        function switchAI(ai) {
            // ì´ì „ AIì˜ ë³€ê²½ì‚¬í•­ ì €ì¥ í™•ì¸
            if (hasUnsavedChanges()) {
                if (!confirm('ì €ì¥ë˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    return;
                }
            }

            // íƒ­ í™œì„±í™”
            document.querySelectorAll('.ai-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-ai="${ai}"]`).classList.add('active');

            currentAI = ai;
            loadPrompts();
        }

        // í”„ë¡¬í”„íŠ¸ ë°ì´í„° ë¡œë“œ
        async function loadPrompts() {
            try {
                const response = await fetch('/api/prompts');
                const data = await response.json();

                promptsData = {};
                originalData = {};

                // ai_prompts.json íŒŒì¼ í˜•ì‹ìœ¼ë¡œ ì²˜ë¦¬
                if (data.success && data.prompts) {
                    const aiNames = Object.keys(data.prompts);

                    aiNames.forEach(aiName => {
                        const aiData = data.prompts[aiName];
                        promptsData[aiName] = {
                            system: [],
                            role: [],
                            guide: [],
                            format: []
                        };

                        // ê° ì¹´í…Œê³ ë¦¬ë³„ë¡œ ì²˜ë¦¬
                        ['system', 'role', 'guide', 'format'].forEach(category => {
                            const categoryData = aiData[category];

                            if (aiName === 'ai1' && category === 'system') {
                                // ai1ì˜ systemì€ ë¬¸ìì—´
                                promptsData[aiName][category] = [{
                                    id: 'ai1_system_0',
                                    content: categoryData || '',
                                    index: 0
                                }];
                            } else if (aiName === 'ai1' && category === 'format') {
                                // ai1ì˜ formatì€ ì½¤ë§ˆë¡œ êµ¬ë¶„ëœ ë¬¸ìì—´
                                promptsData[aiName][category] = [{
                                    id: 'ai1_format_0',
                                    content: categoryData || '',
                                    index: 0
                                }];
                            } else {
                                // ë‹¤ë¥¸ ê²½ìš°ëŠ” ë°°ì—´
                                if (Array.isArray(categoryData)) {
                                    promptsData[aiName][category] = categoryData.map((item, idx) => ({
                                        id: `${aiName}_${category}_${idx}`,
                                        content: item,
                                        index: idx
                                    }));
                                } else {
                                    promptsData[aiName][category] = [];
                                }
                            }
                        });

                        // ì›ë³¸ ë°ì´í„° ë°±ì—…
                        originalData[aiName] = JSON.parse(JSON.stringify(promptsData[aiName]));
                    });
                }

                renderPrompts();
            } catch (error) {
                console.error('í”„ë¡¬í”„íŠ¸ ë¡œë“œ ì˜¤ë¥˜:', error);
                showSaveStatus('í”„ë¡¬í”„íŠ¸ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // í”„ë¡¬í”„íŠ¸ ë Œë”ë§
        function renderPrompts() {
            const categories = ['system', 'role', 'guide', 'format'];

            categories.forEach(category => {
                const container = document.getElementById(`${category}-prompts`);
                const prompts = promptsData[currentAI]?.[category] || [];

                container.innerHTML = '';

                // ëª¨ë“  í”„ë¡¬í”„íŠ¸ ë‚´ìš©ì„ í•˜ë‚˜ì˜ textareaë¡œ í‘œì‹œ
                const textarea = document.createElement('textarea');
                textarea.className = 'unified-textarea';

                // prompts ë°°ì—´ì˜ ëª¨ë“  contentë¥¼ ì ì ˆí•œ í˜•ì‹ìœ¼ë¡œ ì—°ê²°
                let allContent = '';
                if (currentAI === 'ai1' && (category === 'system' || category === 'format')) {
                    // ai1ì˜ systemê³¼ formatì€ ë‹¨ì¼ ë¬¸ìì—´
                    allContent = prompts.length > 0 ? prompts[0].content : '';
                } else {
                    // ë‹¤ë¥¸ ê²½ìš°ëŠ” ë°°ì—´ì˜ contentë“¤ì„ ì¤„ë°”ê¿ˆìœ¼ë¡œ ì—°ê²°
                    allContent = prompts.map(p => p.content).join('\n');
                }

                textarea.value = allContent;
                textarea.id = `${currentAI}-${category}-textarea`;

                // ì…ë ¥ ì´ë²¤íŠ¸ ì²˜ë¦¬
                textarea.addEventListener('input', function () {
                    if (!promptsData[currentAI]) {
                        promptsData[currentAI] = { system: [], role: [], guide: [], format: [] };
                    }

                    if (currentAI === 'ai1' && (category === 'system' || category === 'format')) {
                        // ai1ì˜ systemê³¼ formatì€ ë‹¨ì¼ í•­ëª©ìœ¼ë¡œ ì €ì¥
                        promptsData[currentAI][category] = [{
                            id: `${currentAI}_${category}_0`,
                            content: this.value,
                            index: 0
                        }];
                    } else {
                        // ë‹¤ë¥¸ ê²½ìš°ëŠ” ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„í•˜ì—¬ ë°°ì—´ë¡œ ì €ì¥
                        const lines = this.value.split('\n').filter(line => line.trim());
                        promptsData[currentAI][category] = lines.map((content, idx) => ({
                            id: `${currentAI}_${category}_${idx}`,
                            content: content.trim(),
                            index: idx
                        }));
                    }
                });

                container.appendChild(textarea);

                // ì¹´í…Œê³ ë¦¬ë³„ ì„¤ëª… ì¶”ê°€
                const info = document.createElement('div');
                info.className = 'category-description';
                info.innerHTML = `${getCategoryDescription(category)}`;
                container.appendChild(info);
            });
        }

        // ì¹´í…Œê³ ë¦¬ë³„ ì„¤ëª… ê°€ì ¸ì˜¤ê¸°
        function getCategoryDescription(category) {
            const descriptions = {
                system: 'AIì˜ ê¸°ë³¸ ì‹œìŠ¤í…œ ì„¤ì •ê³¼ ë™ì‘ ì›ì¹™ì„ ì •ì˜í•©ë‹ˆë‹¤. (AI1ì˜ systemì€ ë¬¸ìì—´, ë‚˜ë¨¸ì§€ëŠ” ë°°ì—´)',
                role: 'AIê°€ ìˆ˜í–‰í•  ì—­í• ê³¼ ì±…ì„ì„ ëª…ì‹œí•©ë‹ˆë‹¤. (ë°°ì—´ í˜•ì‹, ê° ì¤„ì— í•˜ë‚˜ì”©)',
                guide: 'AIì˜ ì‘ë‹µ ê°€ì´ë“œë¼ì¸ê³¼ ê·œì¹™ì„ ì„¤ì •í•©ë‹ˆë‹¤. (ë°°ì—´ í˜•ì‹, ê° ì¤„ì— í•˜ë‚˜ì”©)',
                format: 'AIì˜ ì‘ë‹µ í˜•ì‹ê³¼ êµ¬ì¡°ë¥¼ ì •ì˜í•©ë‹ˆë‹¤. (AI1ì€ ì½¤ë§ˆë¡œ êµ¬ë¶„ëœ ë¬¸ìì—´, ë‚˜ë¨¸ì§€ëŠ” ë°°ì—´)'
            };
            return descriptions[category] || '';
        }

        // í”„ë¡¬í”„íŠ¸ ìš”ì†Œ ìƒì„± (ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
        /*
        function createPromptElement(category, prompt, index) {
            const div = document.createElement('div');
            div.className = 'prompt-item';
            div.innerHTML = `
                <div class="prompt-header">
                    <span class="prompt-index">#${index + 1}</span>
                    <div class="prompt-actions">
                        <button class="btn btn-primary" onclick="editPrompt(this)">
                            âœï¸ í¸ì§‘
                        </button>
                        <button class="btn btn-danger" onclick="deletePrompt('${category}', ${index})">
                            ğŸ—‘ï¸ ì‚­ì œ
                        </button>
                    </div>
                </div>
                <div class="prompt-content" contenteditable="false">${escapeHtml(prompt.content)}</div>
            `;
            return div;
        }
        */

        // í”„ë¡¬í”„íŠ¸ í¸ì§‘
        function editPrompt(button) {
            const promptItem = button.closest('.prompt-item');
            const content = promptItem.querySelector('.prompt-content');

            if (content.contentEditable === 'true') {
                // í¸ì§‘ ì™„ë£Œ - ë°ì´í„° ì—…ë°ì´íŠ¸
                const category = getCategoryFromContainer(promptItem);
                const index = getPromptIndex(promptItem);

                // promptsData ì—…ë°ì´íŠ¸
                if (promptsData[currentAI] && promptsData[currentAI][category] && promptsData[currentAI][category][index]) {
                    promptsData[currentAI][category][index].content = content.textContent;
                }

                content.contentEditable = 'false';
                button.textContent = 'âœï¸ í¸ì§‘';
                promptItem.classList.remove('editing');
            } else {
                // í¸ì§‘ ì‹œì‘
                content.contentEditable = 'true';
                content.focus();
                button.textContent = 'ğŸ’¾ ì €ì¥';
                promptItem.classList.add('editing');
            }
        }

        // ì»¨í…Œì´ë„ˆì—ì„œ ì¹´í…Œê³ ë¦¬ ê°€ì ¸ì˜¤ê¸°
        function getCategoryFromContainer(element) {
            const container = element.closest('.prompts-container');
            if (container) {
                const id = container.id;
                return id.replace('-prompts', '');
            }
            return 'system';
        }

        // í”„ë¡¬í”„íŠ¸ ì¸ë±ìŠ¤ ê°€ì ¸ì˜¤ê¸°
        function getPromptIndex(element) {
            const indexElement = element.querySelector('.prompt-index');
            if (indexElement) {
                const text = indexElement.textContent;
                const match = text.match(/#(\d+)/);
                if (match) {
                    return parseInt(match[1]) - 1;
                }
            }
            return 0;
        }

        // ìƒˆ í”„ë¡¬í”„íŠ¸ ì¶”ê°€ (ai1 systemì€ ë¹„í™œì„±)
        function addPromptItem(category) {
            if (currentAI === 'ai1' && category === 'system') return;
            const container = document.getElementById(`${category}-prompts`);
            const addSection = container.querySelector('.add-prompt-section');

            const newPrompt = {
                id: `temp_${Date.now()}`,
                content: '',
                index: (promptsData[currentAI]?.[category]?.length || 0)
            };

            if (!promptsData[currentAI]) {
                promptsData[currentAI] = { system: [], role: [], guide: [], format: [] };
            }

            promptsData[currentAI][category].push(newPrompt);

            // const promptElement = createPromptElement(category, newPrompt, newPrompt.index); // ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
            // container.insertBefore(promptElement, addSection);

            // ìë™ìœ¼ë¡œ í¸ì§‘ ëª¨ë“œ ì‹œì‘
            const content = container.querySelector('.unified-textarea'); // í†µí•© textareaë¥¼ ì°¾ì•„ì„œ ì‚¬ìš©
            const editButton = container.querySelector('.btn-secondary'); // ì¶”ê°€ ë²„íŠ¼ì„ í¸ì§‘ ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½
            content.value = newPrompt.content; // ìƒˆ í”„ë¡¬í”„íŠ¸ì˜ ë‚´ìš©ì„ textareaì— ë°˜ì˜
            content.focus();
            editButton.textContent = 'ğŸ’¾ ì €ì¥';
            // promptElement.classList.add('editing'); // ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
        }

        // í”„ë¡¬í”„íŠ¸ ì‚­ì œ
        function deletePrompt(category, index) {
            if (confirm('ì´ í”„ë¡¬í”„íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                promptsData[currentAI][category].splice(index, 1);
                renderPrompts();
            }
        }

        // ì¹´í…Œê³ ë¦¬ ì €ì¥
        async function saveCategory(category) {
            try {
                // promptsDataë¥¼ ì‹¤ì œ JSON í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                const jsonData = {};

                for (const aiName in promptsData) {
                    jsonData[aiName] = {};

                    for (const cat in promptsData[aiName]) {
                        const prompts = promptsData[aiName][cat] || [];

                        if (aiName === 'ai1' && (cat === 'system' || cat === 'format')) {
                            // ai1ì˜ systemê³¼ formatì€ ë¬¸ìì—´
                            jsonData[aiName][cat] = prompts.length > 0 ? prompts[0].content : '';
                        } else {
                            // ë‹¤ë¥¸ ê²½ìš°ëŠ” ë°°ì—´
                            jsonData[aiName][cat] = prompts.map(p => p.content);
                        }
                    }
                }

                console.log('[í”„ë¡ íŠ¸] ì €ì¥í•  ë°ì´í„°:', jsonData);

                const response = await fetch('/api/prompts', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompts: jsonData
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showSaveStatus(`${getCategoryName(category)} í”„ë¡¬í”„íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');

                    // originalData ì—…ë°ì´íŠ¸
                    if (!originalData[currentAI]) {
                        originalData[currentAI] = { system: [], role: [], guide: [], format: [] };
                    }
                    originalData[currentAI][category] = JSON.parse(JSON.stringify(promptsData[currentAI][category]));

                    console.log('[í”„ë¡ íŠ¸] ì €ì¥ ì„±ê³µ:', result);
                } else {
                    showSaveStatus(`ì €ì¥ ì‹¤íŒ¨: ${result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, 'error');
                    console.error('[í”„ë¡ íŠ¸] ì €ì¥ ì‹¤íŒ¨:', result);
                }
            } catch (error) {
                console.error('[í”„ë¡ íŠ¸] ì €ì¥ ì˜¤ë¥˜:', error);
                showSaveStatus('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ë³€ê²½ì‚¬í•­ í™•ì¸
        function hasUnsavedChanges() {
            const categories = ['system', 'role', 'guide', 'format'];

            for (const category of categories) {
                const current = promptsData[currentAI]?.[category] || [];
                const original = originalData[currentAI]?.[category] || [];

                if (current.length !== original.length) {
                    return true;
                }

                for (let i = 0; i < current.length; i++) {
                    if (current[i].content !== original[i].content) {
                        return true;
                    }
                }
            }

            return false;
        }

        // ì €ì¥ ìƒíƒœ í‘œì‹œ
        function showSaveStatus(message, type) {
            const status = document.getElementById('save-status');
            status.textContent = message;
            status.className = `save-status ${type} show`;

            setTimeout(() => {
                status.classList.remove('show');
            }, 3000);
        }

        // ì¹´í…Œê³ ë¦¬ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
        function getCategoryName(category) {
            const names = {
                'system': 'ì‹œìŠ¤í…œ',
                'role': 'ì—­í• ',
                'guide': 'ê°€ì´ë“œ',
                'format': 'í¬ë§·'
            };
            return names[category] || category;
        }

        // HTML ì´ìŠ¤ì¼€ì´í”„
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            fetch('/api/auth/logout', { method: 'POST' })
                .then(() => {
                    localStorage.removeItem('user');
                    window.location.href = '/';
                })
                .catch(error => {
                    console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
                    window.location.href = '/';
                });
        }

        // í˜ì´ì§€ ë– ë‚  ë•Œ ê²½ê³ 
        window.addEventListener('beforeunload', function (e) {
            if (hasUnsavedChanges()) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>

</html>