#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
EORA AI System - ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬ ëª¨ë“ˆ
MongoDB ì—°ê²° ë° ì»¬ë ‰ì…˜ ê´€ë¦¬ë¥¼ ë‹´ë‹¹í•©ë‹ˆë‹¤.
"""

import os
import sys
import json
import time
import uuid
import logging
from datetime import datetime
from typing import Optional, Dict, List, Any

import pymongo
from bson import ObjectId
from dotenv import load_dotenv

# ë¡œê¹… ì„¤ì •
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

# .env íŒŒì¼ ë¡œë“œ ì‹œë„
try:
    load_dotenv()
    logger.info("âœ… dotenv ë¡œë“œ ì„±ê³µ")
except Exception as e:
    logger.warning(f"âš ï¸ dotenv ë¡œë“œ ì‹¤íŒ¨: {e}")

# MongoDB ì—°ê²° ì •ë³´
MONGODB_URL = os.getenv("MONGODB_URL", "mongodb://localhost:27017")
DATABASE_NAME = os.getenv("DATABASE_NAME", "eora_ai")

# ì „ì—­ ë³€ìˆ˜
mongo_client = None
db = None
sessions_collection = None
chat_logs_collection = None
memories_collection = None
users_collection = None
system_logs_collection = None
points_collection = None

def generate_session_id():
    """ê³ ìœ í•œ ì„¸ì…˜ IDë¥¼ ìƒì„±í•©ë‹ˆë‹¤."""
    return f"session_{uuid.uuid4().hex}"

# ë°ì´í„°ë² ì´ìŠ¤ ë§¤ë‹ˆì € ì¶”ê°€
def db_manager():
    """ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬ ê°ì²´ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤."""
    global mongo_client, db, sessions_collection, chat_logs_collection, users_collection, points_collection
    
    if mongo_client is None:
        init_mongodb_connection()
    
    class DBManager:
        def is_connected(self):
            """ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤."""
            return mongo_client is not None and verify_connection()
            
        async def get_user_sessions(self, user_id):
            """ì‚¬ìš©ìì˜ ì„¸ì…˜ ëª©ë¡ì„ ì¡°íšŒí•©ë‹ˆë‹¤."""
            try:
                if sessions_collection is None:
                    return []
                
                sessions = list(sessions_collection.find({"user_id": user_id}))
                
                # ObjectIdì™€ datetime ì§ë ¬í™”
                for session in sessions:
                    # ObjectIdë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜
                    session["_id"] = str(session["_id"])
                    
                    # ëª¨ë“  í•„ë“œë¥¼ ê²€ì‚¬í•˜ì—¬ datetime ê°ì²´ ë° ê¸°íƒ€ ì§ë ¬í™” ë¶ˆê°€ëŠ¥í•œ íƒ€ì… ì²˜ë¦¬
                    for key, value in list(session.items()):
                        if isinstance(value, datetime):
                            session[key] = value.isoformat()
                        elif hasattr(value, 'isoformat'):  # datetimeê³¼ ìœ ì‚¬í•œ ê°ì²´
                            session[key] = value.isoformat()
                        elif key in ["created_at", "updated_at", "timestamp"] and isinstance(value, (int, float)):
                            # UNIX íƒ€ì„ìŠ¤íƒ¬í”„(ì´ˆ ë‹¨ìœ„) ì²˜ë¦¬
                            session[key] = str(value)
                
                return sessions
            except Exception as e:
                logger.error(f"âŒ ì„¸ì…˜ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: {e}")
                return []
        
        async def create_session(self, session_data):
            """ìƒˆ ì„¸ì…˜ì„ ìƒì„±í•©ë‹ˆë‹¤."""
            try:
                if sessions_collection is None:
                    return None
                
                result = sessions_collection.insert_one(session_data)
                return str(result.inserted_id)
            except Exception as e:
                logger.error(f"âŒ ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨: {e}")
                return None
        
        async def get_session(self, session_id):
            """íŠ¹ì • ì„¸ì…˜ ì •ë³´ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤."""
            try:
                if sessions_collection is None:
                    return None
                
                session = sessions_collection.find_one({"session_id": session_id})
                if session:
                    # ObjectIdë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜
                    session["_id"] = str(session["_id"])
                    
                    # ëª¨ë“  í•„ë“œë¥¼ ê²€ì‚¬í•˜ì—¬ datetime ê°ì²´ ë° ê¸°íƒ€ ì§ë ¬í™” ë¶ˆê°€ëŠ¥í•œ íƒ€ì… ì²˜ë¦¬
                    for key, value in list(session.items()):
                        if isinstance(value, datetime):
                            session[key] = value.isoformat()
                        elif hasattr(value, 'isoformat'):  # datetimeê³¼ ìœ ì‚¬í•œ ê°ì²´
                            session[key] = value.isoformat()
                        elif key in ["created_at", "updated_at", "timestamp"] and isinstance(value, (int, float)):
                            # UNIX íƒ€ì„ìŠ¤íƒ¬í”„(ì´ˆ ë‹¨ìœ„) ì²˜ë¦¬
                            session[key] = str(value)
                
                return session
            except Exception as e:
                logger.error(f"âŒ ì„¸ì…˜ ì¡°íšŒ ì‹¤íŒ¨: {e}")
                return None
        
        async def get_session_messages(self, session_id):
            """ì„¸ì…˜ì˜ ë©”ì‹œì§€ ëª©ë¡ì„ ì¡°íšŒí•©ë‹ˆë‹¤."""
            try:
                if chat_logs_collection is None:
                    return []
                
                messages = list(chat_logs_collection.find({"session_id": session_id}).sort("timestamp", 1))
                
                # ObjectIdì™€ datetime ì§ë ¬í™”
                for message in messages:
                    # ObjectIdë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜
                    message["_id"] = str(message["_id"])
                    
                    # ëª¨ë“  í•„ë“œë¥¼ ê²€ì‚¬í•˜ì—¬ datetime ê°ì²´ ë° ê¸°íƒ€ ì§ë ¬í™” ë¶ˆê°€ëŠ¥í•œ íƒ€ì… ì²˜ë¦¬
                    for key, value in list(message.items()):
                        if isinstance(value, datetime):
                            message[key] = value.isoformat()
                        elif hasattr(value, 'isoformat'):  # datetimeê³¼ ìœ ì‚¬í•œ ê°ì²´
                            message[key] = value.isoformat()
                        elif key in ["created_at", "updated_at", "timestamp"] and isinstance(value, (int, float)):
                            # UNIX íƒ€ì„ìŠ¤íƒ¬í”„(ì´ˆ ë‹¨ìœ„) ì²˜ë¦¬
                            message[key] = str(value)
                
                return messages
            except Exception as e:
                logger.error(f"âŒ ì„¸ì…˜ ë©”ì‹œì§€ ì¡°íšŒ ì‹¤íŒ¨: {e}")
                return []
                
        async def get_user_points(self, user_id):
            """ì‚¬ìš©ìì˜ í¬ì¸íŠ¸ ì •ë³´ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤."""
            try:
                if users_collection is None:
                    return {"points": 100000, "max_points": 100000}
                
                user = users_collection.find_one({"user_id": user_id})
                if user and "points" in user:
                    return {"points": user.get("points", 100000), "max_points": user.get("max_points", 100000)}
                
                # ê¸°ë³¸ê°’
                return {"points": 100000, "max_points": 100000}
            except Exception as e:
                logger.error(f"âŒ í¬ì¸íŠ¸ ì¡°íšŒ ì‹¤íŒ¨: {e}")
                return {"points": 100000, "max_points": 100000}
                
        async def remove_session(self, session_id):
            """ì„¸ì…˜ì„ ì‚­ì œí•©ë‹ˆë‹¤."""
            try:
                if sessions_collection is None:
                    return False
                
                result = sessions_collection.delete_one({"session_id": session_id})
                
                # ê´€ë ¨ ë©”ì‹œì§€ë„ ì‚­ì œ
                if chat_logs_collection is not None:
                    chat_logs_collection.delete_many({"session_id": session_id})
                
                return result.deleted_count > 0
            except Exception as e:
                logger.error(f"âŒ ì„¸ì…˜ ì‚­ì œ ì‹¤íŒ¨: {e}")
                return False
    
        async def update_session(self, session_id, update_data):
            """ì„¸ì…˜ ì •ë³´ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤."""
            try:
                if sessions_collection is None:
                    return False
                
                result = sessions_collection.update_one(
                    {"session_id": session_id},
                    {"$set": update_data}
                )
                
                return result.modified_count > 0
            except Exception as e:
                logger.error(f"âŒ ì„¸ì…˜ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: {e}")
                return False
                
        async def save_message(self, session_id, sender, content):
            """ë©”ì‹œì§€ë¥¼ ì €ì¥í•©ë‹ˆë‹¤."""
            try:
                if chat_logs_collection is None:
                    return None
                
                message_data = {
                    "session_id": session_id,
                    "sender": sender,  # "user" ë˜ëŠ” "ai"
                    "content": content,
                    "timestamp": datetime.now().isoformat()
                }
                
                result = chat_logs_collection.insert_one(message_data)
                return str(result.inserted_id)
            except Exception as e:
                logger.error(f"âŒ ë©”ì‹œì§€ ì €ì¥ ì‹¤íŒ¨: {e}")
                return None
    
    return DBManager()

def init_mongodb_connection():
    """MongoDB ì—°ê²° ë° ì»¬ë ‰ì…˜ ì´ˆê¸°í™”"""
    global mongo_client, db, sessions_collection, chat_logs_collection, memories_collection, users_collection, system_logs_collection, points_collection
    
    # ì—°ê²°ì´ ì´ë¯¸ ì¡´ì¬í•˜ë©´ ì¬ì‚¬ìš©
    if mongo_client is not None:
        return True
        
    try:
        # MongoDB ì—°ê²°
        logger.info("ğŸ”Œ MongoDB ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì„±ê³µ")
        
        # í™˜ê²½ ê°ì§€
        is_railway = os.getenv("RAILWAY", "false").lower() == "true"
        is_production = os.getenv("PRODUCTION", "false").lower() == "true"
        
        if is_railway or is_production:
            logger.info("â˜ï¸ í´ë¼ìš°ë“œ í™˜ê²½ ê°ì§€")
        else:
            logger.info("ğŸ’» ë¡œì»¬ í™˜ê²½ ê°ì§€")
        
        # ì—°ê²° URLs ëª©ë¡ ì¤€ë¹„
        urls = []
        if MONGODB_URL:
            urls.append(MONGODB_URL)
        urls.append("mongodb://localhost:27017")
        
        logger.info(f"ğŸ”— ì—°ê²° ì‹œë„í•  URL ìˆ˜: {len(urls)}")
        
        # ì—°ê²° ì‹œë„
        connected = False
        for idx, url in enumerate(urls, 1):
            try:
                logger.info(f"ğŸ”— MongoDB ì—°ê²° ì‹œë„ {idx}/{len(urls)}: {url}")
                
                # URL ì •ë¦¬ (íŠ¹ìˆ˜ë¬¸ì ë“± ì²˜ë¦¬)
                cleaned_url = url.strip()
                logger.info(f"ğŸ§¹ ì •ë¦¬ëœ URL: {cleaned_url}")
                
                mongo_client = pymongo.MongoClient(cleaned_url, serverSelectionTimeoutMS=5000)
                
                # ì—°ê²° í™•ì¸
                mongo_client.admin.command('ping')
                connected = True
                logger.info("âœ… MongoDB ì—°ê²° ì„±ê³µ!")
                break
                
            except Exception as e:
                logger.error(f"âŒ MongoDB ì—°ê²° ì‹¤íŒ¨ ({url}): {str(e)}")
                continue
        
        if not connected:
            logger.error("âŒ ëª¨ë“  MongoDB ì—°ê²° ì‹œë„ ì‹¤íŒ¨")
            return False
            
        # ë°ì´í„°ë² ì´ìŠ¤ ë° ì»¬ë ‰ì…˜ ì´ˆê¸°í™”
        try:
            db = mongo_client[DATABASE_NAME]
            sessions_collection = db["sessions"]
            chat_logs_collection = db["chat_logs"]
            memories_collection = db["memories"]
            users_collection = db["users"]
            system_logs_collection = db["system_logs"]
            points_collection = db["points"]
            
            # ì¸ë±ìŠ¤ ìƒì„±
            sessions_collection.create_index([("user_id", pymongo.ASCENDING)])
            chat_logs_collection.create_index([("session_id", pymongo.ASCENDING)])
            memories_collection.create_index([("timestamp", pymongo.DESCENDING)])
            
            logger.info("âœ… ì»¬ë ‰ì…˜ ì´ˆê¸°í™” ì„±ê³µ")
            return True
            
        except Exception as e:
            logger.error(f"âŒ ì»¬ë ‰ì…˜ ì´ˆê¸°í™” ì‹¤íŒ¨: {str(e)}")
            return False
            
    except Exception as e:
        logger.error(f"âŒ MongoDB ì—°ê²° ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜: {str(e)}")
        return False

def verify_connection():
    """ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤."""
    global mongo_client
    
    if mongo_client is None:
        return False
        
    try:
        # ì—°ê²° í™•ì¸
        mongo_client.admin.command('ping')
        return True
    except:
        return False

# ìë™ìœ¼ë¡œ ì—°ê²° ì‹œë„
init_mongodb_connection()

# ì—°ê²° ìƒíƒœ í™•ì¸
is_connected = verify_connection()
logger.info(f"ğŸ”Œ MongoDB ì—°ê²° ìƒíƒœ: {'âœ… ì—°ê²°ë¨' if is_connected else 'âŒ ì—°ê²° ì•ˆë¨'}")

def get_cached_mongodb_connection():
    """ìºì‹œëœ MongoDB ì—°ê²°ì„ ë°˜í™˜í•©ë‹ˆë‹¤."""
    global mongo_client
    return mongo_client 