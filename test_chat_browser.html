<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„íŒ… ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }

        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        .test-button:hover {
            background: #0056b3;
        }

        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }

        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
    </style>
</head>

<body>
    <div class="test-container">
        <h1>ğŸ§ª ì±„íŒ… ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸</h1>

        <div class="test-section">
            <h3>1ï¸âƒ£ ì„¸ì…˜ ëª©ë¡ ì¡°íšŒ</h3>
            <button class="test-button" onclick="testGetSessions()">ì„¸ì…˜ ëª©ë¡ ì¡°íšŒ</button>
            <div id="sessions-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>2ï¸âƒ£ ì„¸ì…˜ ìƒì„±</h3>
            <button class="test-button" onclick="testCreateSession()">ìƒˆ ì„¸ì…˜ ìƒì„±</button>
            <div id="create-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>3ï¸âƒ£ ë©”ì‹œì§€ ì €ì¥</h3>
            <input type="text" id="test-message" placeholder="í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€" value="ì•ˆë…•í•˜ì„¸ìš”! ë¸Œë¼ìš°ì € í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤."
                style="width: 300px; padding: 5px;">
            <button class="test-button" onclick="testSaveMessage()">ë©”ì‹œì§€ ì €ì¥</button>
            <div id="save-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>4ï¸âƒ£ ë©”ì‹œì§€ ì¡°íšŒ</h3>
            <input type="text" id="session-id" placeholder="ì„¸ì…˜ ID" style="width: 300px; padding: 5px;">
            <button class="test-button" onclick="testGetMessages()">ë©”ì‹œì§€ ì¡°íšŒ</button>
            <div id="messages-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>5ï¸âƒ£ AI ì±„íŒ…</h3>
            <input type="text" id="chat-message" placeholder="ì±„íŒ… ë©”ì‹œì§€" value="ì•ˆë…•í•˜ì„¸ìš”!"
                style="width: 300px; padding: 5px;">
            <button class="test-button" onclick="testChat()">AI ì±„íŒ…</button>
            <div id="chat-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>6ï¸âƒ£ ì „ì²´ í…ŒìŠ¤íŠ¸</h3>
            <button class="test-button" onclick="runFullTest()">ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
            <div id="full-test-result" class="result"></div>
        </div>
    </div>

    <script>
        const BASE_URL = 'http://127.0.0.1:8001';
        let currentSessionId = null;

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${type}`;
        }

        async function testGetSessions() {
            try {
                showResult('sessions-result', 'ì„¸ì…˜ ëª©ë¡ ì¡°íšŒ ì¤‘...', 'info');

                const response = await fetch(`${BASE_URL}/api/sessions`);
                const data = await response.json();

                if (response.ok) {
                    const sessions = data.sessions || [];
                    const result = `âœ… ì„¸ì…˜ ëª©ë¡ ì¡°íšŒ ì„±ê³µ\n\nì´ ${sessions.length}ê°œ ì„¸ì…˜:\n${sessions.map((s, i) => `${i + 1}. ${s.name} (${s.id})`).join('\n')}`;
                    showResult('sessions-result', result, 'success');

                    // ì²« ë²ˆì§¸ ì„¸ì…˜ ID ì €ì¥
                    if (sessions.length > 0) {
                        currentSessionId = sessions[0].id;
                        document.getElementById('session-id').value = currentSessionId;
                    }
                } else {
                    showResult('sessions-result', `âŒ ì„¸ì…˜ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: ${response.status}\n${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                showResult('sessions-result', `ğŸ’¥ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        async function testCreateSession() {
            try {
                showResult('create-result', 'ìƒˆ ì„¸ì…˜ ìƒì„± ì¤‘...', 'info');

                const response = await fetch(`${BASE_URL}/api/sessions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: 'ë¸Œë¼ìš°ì € í…ŒìŠ¤íŠ¸ ì„¸ì…˜',
                        created_at: new Date().toISOString()
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    currentSessionId = data.session_id;
                    document.getElementById('session-id').value = currentSessionId;
                    showResult('create-result', `âœ… ìƒˆ ì„¸ì…˜ ìƒì„± ì„±ê³µ\n\nì„¸ì…˜ ID: ${currentSessionId}`, 'success');
                } else {
                    showResult('create-result', `âŒ ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨: ${response.status}\n${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                showResult('create-result', `ğŸ’¥ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        async function testSaveMessage() {
            if (!currentSessionId) {
                showResult('save-result', 'âŒ ë¨¼ì € ì„¸ì…˜ì„ ìƒì„±í•˜ê±°ë‚˜ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                const message = document.getElementById('test-message').value;
                showResult('save-result', 'ë©”ì‹œì§€ ì €ì¥ ì¤‘...', 'info');

                const response = await fetch(`${BASE_URL}/api/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        role: 'user',
                        content: message,
                        timestamp: new Date().toISOString()
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showResult('save-result', `âœ… ë©”ì‹œì§€ ì €ì¥ ì„±ê³µ\n\në©”ì‹œì§€: ${message}\nì„¸ì…˜: ${currentSessionId}`, 'success');
                } else {
                    showResult('save-result', `âŒ ë©”ì‹œì§€ ì €ì¥ ì‹¤íŒ¨: ${response.status}\n${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                showResult('save-result', `ğŸ’¥ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        async function testGetMessages() {
            const sessionId = document.getElementById('session-id').value || currentSessionId;

            if (!sessionId) {
                showResult('messages-result', 'âŒ ì„¸ì…˜ IDë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ì„¸ì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                showResult('messages-result', 'ë©”ì‹œì§€ ì¡°íšŒ ì¤‘...', 'info');

                const response = await fetch(`${BASE_URL}/api/sessions/${sessionId}/messages`);
                const data = await response.json();

                if (response.ok) {
                    const messages = data.messages || [];
                    const result = `âœ… ë©”ì‹œì§€ ì¡°íšŒ ì„±ê³µ\n\nì´ ${messages.length}ê°œ ë©”ì‹œì§€:\n${messages.map((msg, i) => `${i + 1}. [${msg.role}] ${msg.content}`).join('\n')}`;
                    showResult('messages-result', result, 'success');
                } else {
                    showResult('messages-result', `âŒ ë©”ì‹œì§€ ì¡°íšŒ ì‹¤íŒ¨: ${response.status}\n${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                showResult('messages-result', `ğŸ’¥ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        async function testChat() {
            if (!currentSessionId) {
                showResult('chat-result', 'âŒ ë¨¼ì € ì„¸ì…˜ì„ ìƒì„±í•˜ê±°ë‚˜ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                const message = document.getElementById('chat-message').value;
                showResult('chat-result', 'AI ì±„íŒ… ì¤‘...', 'info');

                const response = await fetch(`${BASE_URL}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        session_id: currentSessionId
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showResult('chat-result', `âœ… AI ì±„íŒ… ì„±ê³µ\n\nì‚¬ìš©ì: ${message}\nAI: ${data.response}`, 'success');
                } else {
                    showResult('chat-result', `âŒ AI ì±„íŒ… ì‹¤íŒ¨: ${response.status}\n${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                showResult('chat-result', `ğŸ’¥ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        async function runFullTest() {
            showResult('full-test-result', 'ğŸ§ª ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹œì‘...\n\n', 'info');

            try {
                // 1. ì„¸ì…˜ ìƒì„±
                showResult('full-test-result', '1ï¸âƒ£ ìƒˆ ì„¸ì…˜ ìƒì„± ì¤‘...\n', 'info');
                const createResponse = await fetch(`${BASE_URL}/api/sessions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: 'ì „ì²´ í…ŒìŠ¤íŠ¸ ì„¸ì…˜',
                        created_at: new Date().toISOString()
                    })
                });

                if (!createResponse.ok) {
                    throw new Error('ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨');
                }

                const createData = await createResponse.json();
                currentSessionId = createData.session_id;
                showResult('full-test-result', 'âœ… ì„¸ì…˜ ìƒì„± ì™„ë£Œ\n', 'success');

                // 2. ë©”ì‹œì§€ ì €ì¥
                showResult('full-test-result', '2ï¸âƒ£ ë©”ì‹œì§€ ì €ì¥ ì¤‘...\n', 'info');
                const saveResponse = await fetch(`${BASE_URL}/api/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        role: 'user',
                        content: 'ì „ì²´ í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€',
                        timestamp: new Date().toISOString()
                    })
                });

                if (!saveResponse.ok) {
                    throw new Error('ë©”ì‹œì§€ ì €ì¥ ì‹¤íŒ¨');
                }

                showResult('full-test-result', 'âœ… ë©”ì‹œì§€ ì €ì¥ ì™„ë£Œ\n', 'success');

                // 3. AI ì±„íŒ…
                showResult('full-test-result', '3ï¸âƒ£ AI ì±„íŒ… ì¤‘...\n', 'info');
                const chatResponse = await fetch(`${BASE_URL}/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: 'ì•ˆë…•í•˜ì„¸ìš”!',
                        session_id: currentSessionId
                    })
                });

                if (!chatResponse.ok) {
                    throw new Error('AI ì±„íŒ… ì‹¤íŒ¨');
                }

                const chatData = await chatResponse.json();
                showResult('full-test-result', 'âœ… AI ì±„íŒ… ì™„ë£Œ\n', 'success');

                // 4. ë©”ì‹œì§€ ì¡°íšŒ
                showResult('full-test-result', '4ï¸âƒ£ ë©”ì‹œì§€ ì¡°íšŒ ì¤‘...\n', 'info');
                const getResponse = await fetch(`${BASE_URL}/api/sessions/${currentSessionId}/messages`);

                if (!getResponse.ok) {
                    throw new Error('ë©”ì‹œì§€ ì¡°íšŒ ì‹¤íŒ¨');
                }

                const getData = await getResponse.json();
                const messages = getData.messages || [];

                showResult('full-test-result', `ğŸ‰ ì „ì²´ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!\n\nâœ… ëª¨ë“  ê¸°ëŠ¥ì´ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤.\n\nì„¸ì…˜ ID: ${currentSessionId}\nì´ ë©”ì‹œì§€ ìˆ˜: ${messages.length}ê°œ\n\në©”ì‹œì§€ ëª©ë¡:\n${messages.map((msg, i) => `${i + 1}. [${msg.role}] ${msg.content}`).join('\n')}`, 'success');

            } catch (error) {
                showResult('full-test-result', `âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¸ì…˜ ëª©ë¡ ì¡°íšŒ
        window.addEventListener('load', testGetSessions);
    </script>
</body>

</html>